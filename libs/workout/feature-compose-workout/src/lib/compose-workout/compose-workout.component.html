<main class="page-content">
  <form #workoutForm="ngForm" class="workout-form">
    <article fxLayout="row nowrap" fxLayoutAlign="center">
      <section fxFlex="95%">
        <mat-accordion>
          <mat-expansion-panel #matExpansionPanel>
            <mat-expansion-panel-header>
              <mat-panel-title class="title-panel">
                <h3>
                  {{ 'basicInformation.title' | translate }}
                </h3>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <ft-workout-basic-info
              [basicInfo]="resolvedComposedWorkoutData.workoutBasicInfo"
              [exerciseDescriptors]="exerciseDescriptors"
            ></ft-workout-basic-info>
          </mat-expansion-panel>
        </mat-accordion>
      </section>
    </article>

    <section class="exercise-tree-section">
      <mat-tree
        class="exercise-tree"
        [dataSource]="dataSource"
        [treeControl]="treeControl"
        cdkDropList
        (cdkDropListDropped)="drop($event)"
      >
        <mat-tree-node
          *matTreeNodeDef="let node"
          matTreeNodeToggle
          class="exercise"
          [cdkDragData]="node"
          [style.padding-left]="node.level * 24 + 'px'"
          cdkDrag
        >
          <mat-accordion class="exercise__accordion">
            <mat-expansion-panel
              class="accent"
              [class.contrast]="temporarySupersetNodeIds().has(node.id)"
              [disabled]="isSupersetComposeUnderway"
            >
              <mat-expansion-panel-header>
                <mat-panel-title class="exercise-title-panel">
                  <button
                    mat-icon-button
                    color="accent"
                    (click)="
                      showExerciseDetails(node.workoutItem.id);
                      $event.stopPropagation()
                    "
                    [attr.aria-label]="
                      'See details for ' + node.workoutItem.name
                    "
                  >
                    <mat-icon class="mat-icon-rtl-mirror"> search </mat-icon>
                  </button>
                  <h4>
                    {{ node.workoutItem.name }}
                  </h4>
                </mat-panel-title>
                <mat-panel-description class="exercise-description-panel">
                  <ng-container
                    *ngIf="
                      isSupersetComposeUnderway && !node.workoutItem.parent
                    "
                    ><button
                      *ngIf="!temporarySupersetNodeIds().has(node.id)"
                      mat-flat-button
                      class="add-btn"
                      color="primary"
                      (click)="addToSuperset(node); $event.stopPropagation()"
                    >
                      {{ 'actionButtons.add' | translate }}
                    </button>
                    <button
                      *ngIf="temporarySupersetNodeIds().has(node.id)"
                      mat-flat-button
                      class="add-btn"
                      color="primary"
                      (click)="
                        removeFromTemporarySuperset(node);
                        $event.stopPropagation()
                      "
                    >
                      {{ 'actionButtons.remove' | translate }}
                    </button>
                  </ng-container>

                  <button
                    *ngIf="!isSupersetComposeUnderway"
                    mat-icon-button
                    color="warn"
                    (click)="remove(node); $event.stopPropagation()"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </mat-panel-description>
              </mat-expansion-panel-header>
              <div
                class="instruction-form"
                ngModelGroup="{{ node.id }}"
                #instructionsForm="ngModelGroup"
              >
                <ft-workout-item-load
                  class="item-load"
                  [instruction]="node.workoutItem.instructionStrategy"
                ></ft-workout-item-load>
                <ft-workout-item-rest
                  class="item-rest"
                  *ngIf="!node.workoutItem.parent"
                  [instruction]="node.workoutItem.instructionStrategy"
                ></ft-workout-item-rest>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </mat-tree-node>
        <mat-tree-node
          *matTreeNodeDef="let node; when: hasChild"
          class="superset"
          [class.hidden]="isSupersetComposeUnderway"
          [style.padding-left]="node.level * 40 + 'px'"
          cdkDrag
          [cdkDragData]="node"
        >
          <mat-accordion class="superset__accordion">
            <mat-expansion-panel #expansionPanel>
              <mat-expansion-panel-header class="superset-panel-header">
                <mat-panel-title class="superset-title-panel">
                  <button
                    mat-icon-button
                    matTreeNodeToggle
                    color="accent"
                    (click)="
                      treeExpansionModel.toggle(node.id); expansionPanel.close()
                    "
                    [attr.aria-label]="
                      'See details for ' + node.workoutItem.name
                    "
                  >
                    <mat-icon class="mat-icon-rtl-mirror"> search </mat-icon>
                  </button>

                  <h4>{{ node.workoutItem.name }}</h4>
                </mat-panel-title>
                <mat-panel-description class="superset-panel-description">
                  <button
                    mat-stroked-button
                    color="primary"
                    (click)="decompose(node)"
                  >
                    {{ 'actionButtons.decompose' | translate }}
                  </button>
                </mat-panel-description>
              </mat-expansion-panel-header>
              <div
                class="superset-form"
                ngModelGroup="{{ node.id }}"
                #supersetInstructionsForm="ngModelGroup"
              >
                <ft-workout-item-load
                  [instruction]="node.workoutItem.instructionStrategy"
                ></ft-workout-item-load>
                <mat-divider></mat-divider>
                <ft-workout-item-rest
                  [instruction]="node.workoutItem.instructionStrategy"
                ></ft-workout-item-rest>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </mat-tree-node>
      </mat-tree>
    </section>
  </form>
</main>

<footer class="compose-workout-actions">
  <button
    mat-stroked-button
    class="workout-btn"
    color="primary"
    (click)="toggleComposeSuperset()"
  >
    {{
      (isSupersetComposeUnderway
        ? 'actionButtons.discardSuperset'
        : 'actionButtons.composeSuperset'
      ) | translate
    }}
  </button>
  <button
    *ngIf="isSupersetComposeUnderway"
    mat-stroked-button
    class="workout-btn"
    color="accent"
    [disabled]="temporarySupersetNodeIds().size < 2"
    (click)="saveSuperset()"
  >
    {{ 'actionButtons.saveSuperset' | translate }}
  </button>
  <div
    matTooltip="{{ 'actionButtons.saveWorkoutDisabledTooltip' | translate }}"
    [matTooltipDisabled]="!workoutForm.invalid"
  >
    <button
      mat-raised-button
      color="accent"
      [disabled]="workoutForm.invalid"
      (click)="saveWorkout()"
    >
      {{ 'actionButtons.saveWorkout' | translate }}
    </button>
  </div>
</footer>
